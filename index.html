<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Escape Game Multijoueur</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            margin: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .hidden {
            display: none !important;
        }
        .fade-in {
            animation: fadeIn 0.5s;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .pulse {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-900 via-blue-900 to-indigo-900 min-h-screen">
    
    <!-- Audio -->
    <audio id="bgMusic" loop>
        <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBTGH0fPTgjMGHm7A7+OZUQ8PVKni7q9cFwlAnN7xwHAfBSyAzPLaizsIHGS57OihUQ8RU6Dp6qNJCw2" type="audio/wav">
    </audio>

    <!-- √âcran de connexion -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-8 max-w-md w-full border border-white/20 shadow-2xl fade-in">
            <h1 class="text-4xl font-bold text-white text-center mb-8">üîê Escape Game</h1>
            
            <div class="space-y-4">
                <div>
                    <label class="text-white font-semibold block mb-2">Pseudo</label>
                    <input type="text" id="pseudoInput" 
                        class="w-full px-4 py-3 rounded-lg bg-white/20 text-white placeholder-white/60 border border-white/30 focus:outline-none focus:ring-2 focus:ring-purple-400"
                        placeholder="Entrez votre pseudo">
                </div>

                <div>
                    <label class="text-white font-semibold block mb-2">Avatar</label>
                    <div id="avatarGrid" class="grid grid-cols-4 gap-2">
                        <!-- Avatars g√©n√©r√©s par JS -->
                    </div>
                </div>

                <div>
                    <label class="text-white font-semibold block mb-2">R√¥le</label>
                    <select id="roleSelect" class="w-full px-4 py-3 rounded-lg bg-white/20 text-black font-bold border border-white/30 focus:outline-none focus:ring-2 focus:ring-purple-400">
                        <option value="player">Joueur</option>
                        <option value="host">H√¥te de partie</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>

                <div id="playerCodeDiv" class="hidden">
                    <label class="text-white font-semibold block mb-2">Code de la Partie</label>
                    <input type="text" id="playerRoomCodeInput" 
                        class="w-full px-4 py-3 rounded-lg bg-white/20 text-white placeholder-white/60 border border-white/30 focus:outline-none focus:ring-2 focus:ring-purple-400"
                        placeholder="Entrez le code de la partie">
                </div>

                <button onclick="login()" class="w-full bg-gradient-to-r from-purple-500 to-pink-500 text-white font-bold py-3 rounded-lg hover:from-purple-600 hover:to-pink-600 transition shadow-lg">
                    Rejoindre
                </button>
            </div>
        </div>
    </div>

    <!-- √âcran Lobby -->
    <div id="lobbyScreen" class="hidden min-h-screen p-4">
        <!-- Header -->
        <div class="max-w-6xl mx-auto mb-6">
            <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-4 border border-white/20 flex items-center justify-between flex-wrap gap-4">
                <div class="flex items-center gap-3">
                    <div class="text-4xl" id="userAvatar"></div>
                    <div>
                        <div class="text-white font-bold" id="userPseudo"></div>
                        <div class="text-white/60 text-sm" id="userRole"></div>
                    </div>
                </div>
                
                <div class="flex items-center gap-3">
                    <div id="roomCodeDiv" class="bg-white/20 px-4 py-2 rounded-lg hidden">
                        <div class="text-white/60 text-xs">Code Salle</div>
                        <div class="text-white font-mono font-bold" id="roomCode"></div>
                    </div>
                    <button onclick="toggleMusic()" class="p-3 bg-white/20 rounded-lg hover:bg-white/30 transition text-white">
                        <span id="musicIcon">üîä</span>
                    </button>
                    <button onclick="logout()" class="p-3 bg-red-500/80 rounded-lg hover:bg-red-600 transition text-white">
                        ‚Ü©Ô∏è
                    </button>
                </div>
            </div>
        </div>

        <div class="max-w-6xl mx-auto grid gap-6">
            <!-- Joueurs -->
            <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20">
                <h2 class="text-2xl font-bold text-white mb-4">üë• Joueurs (<span id="playerCount">0</span>)</h2>
                <div id="playersList" class="space-y-2 max-h-96 overflow-y-auto">
                    <!-- Joueurs g√©n√©r√©s par JS -->
                </div>
                
                <!-- Bouton commencer (visible uniquement pour l'h√¥te/admin) -->
                <button onclick="startGameForAll()" id="startGameBtn" class="w-full mt-6 bg-gradient-to-r from-green-500 to-emerald-500 text-white font-bold py-3 rounded-lg hover:from-green-600 hover:to-emerald-600 transition shadow-lg hidden">
                    üéÆ Commencer la Partie
                </button>
            </div>

            <!-- Gestion des questions (visible uniquement pour host/admin) -->
            <div id="questionsPanel" class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20 hidden">
                <h2 class="text-2xl font-bold text-white mb-4">‚öôÔ∏è Questions (<span id="questionCount">0</span>)</h2>
                
                <div class="space-y-3 mb-4">
                    <input type="text" id="questionInput" placeholder="Question..."
                        class="w-full px-4 py-2 rounded-lg bg-white/20 text-white placeholder-white/60 border border-white/30 focus:outline-none focus:ring-2 focus:ring-purple-400">
                    
                    <div class="space-y-2">
                        <div class="flex gap-2">
                            <input type="text" id="option0" placeholder="Option 1"
                                class="flex-1 px-4 py-2 rounded-lg bg-white/20 text-white placeholder-white/60 border border-white/30 focus:outline-none">
                            <button onclick="selectCorrect(0)" id="correct0" class="px-4 py-2 rounded-lg bg-white/20 text-white/60 hover:bg-white/30 transition">‚úì</button>
                        </div>
                        <div class="flex gap-2">
                            <input type="text" id="option1" placeholder="Option 2"
                                class="flex-1 px-4 py-2 rounded-lg bg-white/20 text-white placeholder-white/60 border border-white/30 focus:outline-none">
                            <button onclick="selectCorrect(1)" id="correct1" class="px-4 py-2 rounded-lg bg-white/20 text-white/60 hover:bg-white/30 transition">‚úì</button>
                        </div>
                        <div class="flex gap-2">
                            <input type="text" id="option2" placeholder="Option 3"
                                class="flex-1 px-4 py-2 rounded-lg bg-white/20 text-white placeholder-white/60 border border-white/30 focus:outline-none">
                            <button onclick="selectCorrect(2)" id="correct2" class="px-4 py-2 rounded-lg bg-white/20 text-white/60 hover:bg-white/30 transition">‚úì</button>
                        </div>
                        <div class="flex gap-2">
                            <input type="text" id="option3" placeholder="Option 4"
                                class="flex-1 px-4 py-2 rounded-lg bg-white/20 text-white placeholder-white/60 border border-white/30 focus:outline-none">
                            <button onclick="selectCorrect(3)" id="correct3" class="px-4 py-2 rounded-lg bg-white/20 text-white/60 hover:bg-white/30 transition">‚úì</button>
                        </div>
                    </div>
                    
                    <button onclick="addQuestion()" class="w-full bg-gradient-to-r from-green-500 to-emerald-500 text-white font-bold py-2 rounded-lg hover:from-green-600 hover:to-emerald-600 transition">
                        ‚ûï Ajouter Question
                    </button>
                </div>

                <div id="questionsList" class="space-y-2 max-h-64 overflow-y-auto mb-4">
                    <!-- Questions g√©n√©r√©es par JS -->
                </div>
            </div>
        </div>
    </div>

    <!-- √âcran de jeu -->
    <div id="gameScreen" class="hidden min-h-screen flex items-center justify-center p-4">
        <div class="max-w-3xl w-full">
            <div class="mb-6 bg-white/10 backdrop-blur-lg rounded-2xl p-4 border border-white/20">
                <div class="flex justify-between text-white mb-2">
                    <span>Question <span id="currentQ">1</span> / <span id="totalQ">1</span></span>
                    <span class="font-bold">Score: <span id="currentScore">0</span></span>
                </div>
                <div class="flex justify-between text-white mb-2">
                    <span class="text-2xl font-bold">‚è±Ô∏è <span id="timer">15</span>s</span>
                </div>
                <div class="w-full bg-white/20 rounded-full h-2">
                    <div id="progressBar" class="bg-gradient-to-r from-purple-500 to-pink-500 h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
                </div>
            </div>

            <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-8 border border-white/20">
                <h2 id="questionText" class="text-3xl font-bold text-white mb-8 text-center"></h2>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="optionsGrid">
                    <!-- Options g√©n√©r√©es par JS -->
                </div>

                <div id="correctAnswerDisplay" class="hidden mt-6 p-4 bg-green-500/30 border border-green-500 rounded-xl">
                    <p class="text-white text-center font-bold">‚úÖ Bonne r√©ponse: <span id="correctAnswerText"></span></p>
                </div>
            </div>
        </div>
    </div>

    <!-- √âcran r√©sultats -->
    <div id="resultsScreen" class="hidden min-h-screen flex items-center justify-center p-4">
        <div class="max-w-2xl w-full bg-white/10 backdrop-blur-lg rounded-2xl p-8 border border-white/20">
            <h1 class="text-4xl font-bold text-white text-center mb-8">üèÜ R√©sultats Finaux üèÜ</h1>
            <div id="resultsList" class="space-y-3 mb-8">
                <!-- R√©sultats g√©n√©r√©s par JS -->
            </div>
            <button onclick="backToLobby()" class="w-full bg-gradient-to-r from-purple-500 to-pink-500 text-white font-bold py-3 rounded-lg hover:from-purple-600 hover:to-pink-600 transition shadow-lg">
                Retour au Lobby
            </button>
        </div>
    </div>

    <script>
        // Variables globales
        const AVATARS = ['üßô‚Äç‚ôÇÔ∏è', 'ü¶∏‚Äç‚ôÄÔ∏è', 'ü§ñ', 'üë®‚ÄçüöÄ', 'üßõ‚Äç‚ôÇÔ∏è', 'üßö‚Äç‚ôÄÔ∏è', 'ü¶π‚Äç‚ôÇÔ∏è', 'üëæ'];
        const ADMIN_CODE = 'egm2024secure';
        
        let currentUser = null;
        let players = [];
        let questions = [];
        let currentQuestionIndex = 0;
        let selectedAvatar = AVATARS[0];
        let correctAnswerIndex = 0;
        let hasAnswered = false;
        let musicOn = true;
        let roomCode = null;
        let timerInterval = null;
        let timeLeft = 15;
        let currentRoomData = null;

        // Initialisation
        document.addEventListener('DOMContentLoaded', async () => {
            initAvatars();
            
            document.getElementById('roleSelect').addEventListener('change', (e) => {
                document.getElementById('playerCodeDiv').classList.toggle('hidden', e.target.value !== 'player');
            });
        });

        function initAvatars() {
            const grid = document.getElementById('avatarGrid');
            AVATARS.forEach((avatar, idx) => {
                const btn = document.createElement('button');
                btn.className = 'text-4xl p-3 rounded-lg transition ' + (idx === 0 ? 'bg-purple-500 scale-110' : 'bg-white/20 hover:bg-white/30');
                btn.textContent = avatar;
                btn.onclick = () => selectAvatar(avatar, btn);
                grid.appendChild(btn);
            });
        }

        function selectAvatar(avatar, btn) {
            selectedAvatar = avatar;
            document.querySelectorAll('#avatarGrid button').forEach(b => {
                b.className = 'text-4xl p-3 rounded-lg transition bg-white/20 hover:bg-white/30';
            });
            btn.className = 'text-4xl p-3 rounded-lg transition bg-purple-500 scale-110';
        }

        async function login() {
            const pseudo = document.getElementById('pseudoInput').value.trim();
            const role = document.getElementById('roleSelect').value;
            const playerRoomCode = document.getElementById('playerRoomCodeInput').value.trim().toUpperCase();

            if (!pseudo) {
                alert('Veuillez entrer un pseudo !');
                return;
            }

            if (role === 'player') {
                if (!playerRoomCode) {
                    alert('Veuillez entrer le code de la partie !');
                    return;
                }
                
                // V√©rifier si la partie existe dans le stockage partag√©
                try {
                    const roomData = await window.storage.get(`room:${playerRoomCode}`, true);
                    if (!roomData) {
                        alert('Code de partie invalide ! Aucune partie trouv√©e avec ce code.\nDemandez √† l\'h√¥te de v√©rifier le code.');
                        return;
                    }
                    
                    // Charger les donn√©es de la partie
                    currentRoomData = JSON.parse(roomData.value);
                    roomCode = playerRoomCode;
                    questions = currentRoomData.questions || [];
                    players = currentRoomData.players || [];
                    
                } catch (error) {
                    alert('Code de partie invalide ! Aucune partie trouv√©e avec ce code.\nDemandez √† l\'h√¥te de v√©rifier le code.');
                    return;
                }
            }

            currentUser = {
                id: Date.now(),
                pseudo: pseudo,
                avatar: selectedAvatar,
                role: role,
                score: 0
            };

            players.push(currentUser);
            
            if (role === 'host' || role === 'admin') {
                roomCode = Math.random().toString(36).substring(2, 8).toUpperCase();
                document.getElementById('roomCode').textContent = roomCode;
                document.getElementById('roomCodeDiv').classList.remove('hidden');
                document.getElementById('questionsPanel').classList.remove('hidden');
                
                // Sauvegarder la partie dans le stockage partag√©
                await saveRoomData();
            } else {
                // Sauvegarder la partie mise √† jour avec le nouveau joueur
                await saveRoomData();
            }

            showScreen('lobbyScreen');
            updateLobby();
            
            // D√©marrer la synchronisation pour les joueurs
            if (role === 'player') {
                startSync();
            }
        }

        async function saveRoomData() {
            if (!roomCode) return;
            
            try {
                const roomData = {
                    code: roomCode,
                    players: players,
                    questions: questions,
                    lastUpdate: Date.now()
                };
                await window.storage.set(`room:${roomCode}`, JSON.stringify(roomData), true);
            } catch (error) {
                console.error('Erreur de sauvegarde:', error);
            }
        }

        async function loadRoomData() {
            if (!roomCode) return;
            
            try {
                const roomData = await window.storage.get(`room:${roomCode}`, true);
                if (roomData) {
                    const data = JSON.parse(roomData.value);
                    
                    // Mettre √† jour les joueurs (sauf l'utilisateur actuel)
                    const otherPlayers = data.players.filter(p => p.id !== currentUser.id);
                    const currentUserData = players.find(p => p.id === currentUser.id);
                    players = [...otherPlayers, currentUserData];
                    
                    // Mettre √† jour les questions
                    questions = data.questions || [];
                    
                    updateLobby();
                }
            } catch (error) {
                console.error('Erreur de chargement:', error);
            }
        }

        function startSync() {
            // Synchroniser toutes les 2 secondes
            setInterval(async () => {
                if (currentUser && currentUser.role === 'player' && roomCode) {
                    await loadRoomData();
                }
            }, 2000);
        }

        function updateLobby() {
            document.getElementById('userAvatar').textContent = currentUser.avatar;
            document.getElementById('userPseudo').textContent = currentUser.pseudo + (currentUser.role === 'admin' ? ' üëë' : currentUser.role === 'host' ? ' üõ°Ô∏è' : '');
            document.getElementById('userRole').textContent = currentUser.role;
            document.getElementById('playerCount').textContent = players.length;

            const list = document.getElementById('playersList');
            list.innerHTML = '';
            players.forEach(player => {
                const div = document.createElement('div');
                div.className = 'bg-white/10 rounded-lg p-3 flex items-center justify-between';
                div.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="text-3xl">${player.avatar}</div>
                        <div>
                            <div class="text-white font-semibold">
                                ${player.pseudo}
                                ${player.role === 'admin' ? 'üëë' : player.role === 'host' ? 'üõ°Ô∏è' : ''}
                            </div>
                            <div class="text-white/60 text-sm">${player.role}</div>
                        </div>
                    </div>
                    ${(currentUser.role === 'admin' || currentUser.role === 'host') && player.id !== currentUser.id && player.role === 'player' ? 
                        `<button onclick="kickPlayer(${player.id})" class="p-2 bg-red-500/50 rounded-lg hover:bg-red-600 transition text-white">‚ùå</button>` : ''}
                `;
                list.appendChild(div);
            });

            // Afficher le bouton commencer si host/admin et qu'il y a des questions
            if ((currentUser.role === 'host' || currentUser.role === 'admin') && questions.length > 0) {
                document.getElementById('startGameBtn').classList.remove('hidden');
            }
            
            // Afficher le code de salle si c'est un joueur et qu'il a rejoint une partie
            if (currentUser.role === 'player' && roomCode) {
                document.getElementById('roomCode').textContent = roomCode;
                document.getElementById('roomCodeDiv').classList.remove('hidden');
            }
        }

        function kickPlayer(playerId) {
            players = players.filter(p => p.id !== playerId);
            updateLobby();
            saveRoomData();
        }

        function selectCorrect(idx) {
            correctAnswerIndex = idx;
            for (let i = 0; i < 4; i++) {
                const btn = document.getElementById(`correct${i}`);
                btn.className = i === idx ? 
                    'px-4 py-2 rounded-lg bg-green-500 text-white transition' : 
                    'px-4 py-2 rounded-lg bg-white/20 text-white/60 hover:bg-white/30 transition';
            }
        }

        function addQuestion() {
            const question = document.getElementById('questionInput').value.trim();
            const options = [
                document.getElementById('option0').value.trim(),
                document.getElementById('option1').value.trim(),
                document.getElementById('option2').value.trim(),
                document.getElementById('option3').value.trim()
            ];

            if (!question || options.some(opt => !opt)) {
                alert('Veuillez remplir tous les champs !');
                return;
            }

            questions.push({
                id: Date.now(),
                question: question,
                options: options,
                correct: correctAnswerIndex
            });

            document.getElementById('questionInput').value = '';
            for (let i = 0; i < 4; i++) {
                document.getElementById(`option${i}`).value = '';
            }
            selectCorrect(0);

            updateQuestionsList();
            saveRoomData();
        }

        function updateQuestionsList() {
            document.getElementById('questionCount').textContent = questions.length;
            const list = document.getElementById('questionsList');
            list.innerHTML = '';
            
            questions.forEach((q, idx) => {
                const div = document.createElement('div');
                div.className = 'bg-white/10 rounded-lg p-3';
                div.innerHTML = `
                    <div class="text-white font-semibold">${idx + 1}. ${q.question}</div>
                    <div class="text-white/60 text-sm mt-1">R√©ponse: ${q.options[q.correct]}</div>
                `;
                list.appendChild(div);
            });

            // Afficher le bouton commencer si on a des questions
            if (questions.length > 0) {
                document.getElementById('startGameBtn').classList.remove('hidden');
            }
        }

        function startGameForAll() {
            if (questions.length === 0) {
                alert('Ajoutez au moins une question !');
                return;
            }
            currentQuestionIndex = 0;
            hasAnswered = false;
            timeLeft = 15;
            showScreen('gameScreen');
            displayQuestion();
        }

        function displayQuestion() {
            hasAnswered = false;
            timeLeft = 15;
            document.getElementById('correctAnswerDisplay').classList.add('hidden');
            
            const q = questions[currentQuestionIndex];
            document.getElementById('currentQ').textContent = currentQuestionIndex + 1;
            document.getElementById('totalQ').textContent = questions.length;
            document.getElementById('currentScore').textContent = currentUser.score;
            document.getElementById('progressBar').style.width = ((currentQuestionIndex + 1) / questions.length * 100) + '%';
            document.getElementById('questionText').textContent = q.question;
            document.getElementById('timer').textContent = timeLeft;

            const grid = document.getElementById('optionsGrid');
            grid.innerHTML = '';
            
            q.options.forEach((option, idx) => {
                const btn = document.createElement('button');
                btn.className = 'bg-white/20 hover:bg-white/30 text-white font-semibold py-4 px-6 rounded-xl transition transform hover:scale-105';
                btn.textContent = option;
                btn.onclick = () => answerQuestion(idx, btn);
                grid.appendChild(btn);
            });

            // D√©marrer le chrono
            startTimer();
        }

        function startTimer() {
            if (timerInterval) clearInterval(timerInterval);
            
            timerInterval = setInterval(() => {
                timeLeft--;
                document.getElementById('timer').textContent = timeLeft;

                // √Ä 0 seconde, fin du temps pour r√©pondre
                if (timeLeft === 0) {
                    if (!hasAnswered) {
                        hasAnswered = true;
                        disableAllButtons();
                    }
                    showCorrectAnswer();
                }

                // √Ä -5 secondes (5 secondes apr√®s affichage r√©ponse), passer √† la question suivante
                if (timeLeft === -5) {
                    clearInterval(timerInterval);
                    if (currentQuestionIndex < questions.length - 1) {
                        currentQuestionIndex++;
                        displayQuestion();
                    } else {
                        showResults();
                    }
                }
            }, 1000);
        }

        function disableAllButtons() {
            const buttons = document.querySelectorAll('#optionsGrid button');
            buttons.forEach(b => {
                b.disabled = true;
                b.classList.remove('hover:bg-white/30', 'hover:scale-105');
            });
        }

        function showCorrectAnswer() {
            const q = questions[currentQuestionIndex];
            const buttons = document.querySelectorAll('#optionsGrid button');
            
            buttons.forEach((b, i) => {
                if (i === q.correct) {
                    b.className = 'bg-green-500 text-white font-semibold py-4 px-6 rounded-xl';
                }
            });

            document.getElementById('correctAnswerText').textContent = q.options[q.correct];
            document.getElementById('correctAnswerDisplay').classList.remove('hidden');
        }

        function answerQuestion(idx, btn) {
            if (hasAnswered || timeLeft <= 0) return;
            hasAnswered = true;

            const q = questions[currentQuestionIndex];
            const isCorrect = idx === q.correct;

            disableAllButtons();

            if (isCorrect) {
                btn.className = 'bg-green-500 text-white font-semibold py-4 px-6 rounded-xl';
                currentUser.score += 1;
                players = players.map(p => p.id === currentUser.id ? {...p, score: p.score + 1} : p);
                document.getElementById('currentScore').textContent = currentUser.score;
            } else {
                btn.className = 'bg-red-500 text-white font-semibold py-4 px-6 rounded-xl';
            }

            // Afficher la bonne r√©ponse
            showCorrectAnswer();
        }

        function showResults() {
            showScreen('resultsScreen');
            const sortedPlayers = [...players].sort((a, b) => b.score - a.score);
            
            const list = document.getElementById('resultsList');
            list.innerHTML = '';
            
            sortedPlayers.forEach((player, idx) => {
                const div = document.createElement('div');
                div.className = `bg-white/10 rounded-lg p-4 flex items-center justify-between ${idx === 0 ? 'ring-4 ring-yellow-400' : ''}`;
                div.innerHTML = `
                    <div class="flex items-center gap-4">
                        <div class="text-2xl font-bold text-white/60">#${idx + 1}</div>
                        <div class="text-4xl">${player.avatar}</div>
                        <div>
                            <div class="text-white font-bold">${player.pseudo}</div>
                            <div class="text-white/60 text-sm">${player.score} points</div>
                        </div>
                    </div>
                    ${idx === 0 ? '<span class="text-4xl">üëë</span>' : ''}
                `;
                list.appendChild(div);
            });
        }

        function backToLobby() {
            if (timerInterval) clearInterval(timerInterval);
            currentQuestionIndex = 0;
            players = players.map(p => ({...p, score: 0}));
            currentUser.score = 0;
            timeLeft = 15;
            showScreen('lobbyScreen');
            updateLobby();
        }

        function toggleMusic() {
            musicOn = !musicOn;
            const audio = document.getElementById('bgMusic');
            const icon = document.getElementById('musicIcon');
            
            if (musicOn) {
                audio.play();
                icon.textContent = 'üîä';
            } else {
                audio.pause();
                icon.textContent = 'üîá';
            }
        }

        async function logout() {
            if (timerInterval) clearInterval(timerInterval);
            
            // Si on est l'h√¥te, on peut supprimer la partie
            if (currentUser && (currentUser.role === 'host' || currentUser.role === 'admin') && roomCode) {
                try {
                    await window.storage.delete(`room:${roomCode}`, true);
                } catch (error) {
                    console.error('Erreur de suppression:', error);
                }
            }
            
            players = [];
            questions = [];
            currentUser = null;
            roomCode = null;
            timeLeft = 15;
            currentRoomData = null;
            showScreen('loginScreen');
        }

        function showScreen(screenId) {
            ['loginScreen', 'lobbyScreen', 'gameScreen', 'resultsScreen'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            document.getElementById(screenId).classList.remove('hidden');
        }
    </script>
</body>
</html>
